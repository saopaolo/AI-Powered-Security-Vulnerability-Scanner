import boto3
import openai

# AWS configuration
AWS_REGION = 'us-west-2'
INSTANCE_ID = 'i-0abcd1234efgh5678'  # Replace with your EC2 instance ID

# OpenAI API configuration
openai.api_key = 'your-chatgpt-api-key'

def start_ec2_instance(instance_id):
    ec2 = boto3.client('ec2', region_name=AWS_REGION)
    response = ec2.start_instances(InstanceIds=[instance_id])
    print(f"Starting EC2 instance: {instance_id}")
    return response

def stop_ec2_instance(instance_id):
    ec2 = boto3.client('ec2', region_name=AWS_REGION)
    response = ec2.stop_instances(InstanceIds=[instance_id])
    print(f"Stopping EC2 instance: {instance_id}")
    return response

def analyze_vulnerability(code_snippet):
    prompt = f"Analyze the following code for security vulnerabilities and provide suggestions:\n\n{code_snippet}"
    response = openai.Completion.create(
        engine="davinci-codex",
        prompt=prompt,
        max_tokens=150
    )
    return response.choices[0].text.strip()

def execute_query(query, params):
    import psycopg2
    try:
        connection = psycopg2.connect(
            user="your_user",
            password="your_password",
            host="your_host",
            port="your_port",
            database="your_database"
        )
        cursor = connection.cursor()
        cursor.execute(query, params)
        connection.commit()
        print("Query executed successfully")
    except (Exception, psycopg2.Error) as error:
        print("Error while executing query:", error)
    finally:
        if connection:
            cursor.close()
            connection.close()

if __name__ == "__main__":
    # Start the EC2 instance
    start_ec2_instance(INSTANCE_ID)

    # Example code snippet to analyze
    code_snippet = """
    user_id = input("Enter user ID: ")
    query = f"SELECT * FROM users WHERE id = {user_id}"
    execute_query(query, [])
    """

    # Analyze the code snippet for vulnerabilities
    analysis = analyze_vulnerability(code_snippet)
    print("Vulnerability Analysis:")
    print(analysis)

    # Stop the EC2 instance
    stop_ec2_instance(INSTANCE_ID)
